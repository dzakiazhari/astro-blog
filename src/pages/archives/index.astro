---
import { getCollection } from "astro:content";
import Main from "@/layouts/Main.astro";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import { getPath } from "@/utils/getPath";
import Datetime from "@/components/Datetime.astro";
import getPostsByGroupCondition from "@/utils/getPostsByGroupCondition";
import { SITE } from "@/config";

// Redirect to 404 page if `showArchives` config is false
if (!SITE.showArchives) {
  return Astro.redirect("/404");
}

const posts = await getCollection("blog", ({ data }) => !data.draft);
---

<Layout title={`Archives | ${SITE.title}`}>
  <Header />
  <Main pageTitle="Archives" pageDesc="All the articles I've archived.">
    {
      Object.entries(
        getPostsByGroupCondition(posts, post =>
          post.data.pubDatetime.getFullYear()
        )
      )
        .sort(([yearA], [yearB]) => Number(yearB) - Number(yearA))
        .map(([year, yearGroup]) => {
          const sortedYear = yearGroup.sort(
            (a, b) =>
              new Date(b.data.pubDatetime).getTime() -
              new Date(a.data.pubDatetime).getTime()
          );
          const topFive = sortedYear.slice(0, 5);
          const hasMore = sortedYear.length > 5;

          return (
            <section class="mt-12">
              <header class="flex items-center gap-3">
                <span class="rounded-full border border-accent/30 bg-accent/10 px-4 py-1 text-xs font-semibold tracking-[0.32em] text-accent/80 uppercase">
                  {year}
                </span>
                <sup class="text-sm text-foreground/50">
                  {sortedYear.length}
                </sup>
              </header>
              <ol class="relative my-6 ms-3 space-y-4 border-s border-border/60 ps-5">
                {topFive.map(({ data, id, filePath }) => (
                  <li class="relative rounded-xl border border-border/50 bg-background/70 p-4 shadow-sm transition hover:-translate-y-0.5 hover:border-accent/40 hover:shadow-lg">
                    <span class="absolute start-[-2.65rem] top-1.5 inline-block size-2 rounded-full border border-accent/40 bg-accent/80" />
                    <a
                      href={getPath(id, filePath)}
                      class="block text-base font-semibold text-foreground transition hover:text-accent focus-visible:ring-2 focus-visible:ring-accent/50 focus-visible:outline-none"
                      data-astro-prefetch="viewport"
                    >
                      {data.title}
                    </a>
                    <Datetime
                      class="mt-2 text-xs text-foreground/60"
                      pubDatetime={data.pubDatetime}
                      modDatetime={data.modDatetime}
                      timezone={data.timezone}
                    />
                  </li>
                ))}
                {hasMore && (
                  <li class="relative ps-2 text-sm tracking-[0.28em] text-foreground/50 uppercase">
                    â€¦
                  </li>
                )}
              </ol>
            </section>
          );
        })
    }
  </Main>
  <Footer />
</Layout>
