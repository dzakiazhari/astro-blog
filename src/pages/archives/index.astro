---
import { getCollection } from "astro:content";
import Main from "@/layouts/Main.astro";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import { getPath } from "@/utils/getPath";
import Datetime from "@/components/Datetime.astro";
import getPostsByGroupCondition from "@/utils/getPostsByGroupCondition";
import { SITE } from "@/config";

// Redirect to 404 page if `showArchives` config is false
if (!SITE.showArchives) {
  return Astro.redirect("/404");
}

const posts = await getCollection("blog", ({ data }) => !data.draft);

---

<Layout title={`Archives | ${SITE.title}`}>
  <Header />
  <Main pageTitle="Archives" pageDesc="All the articles I've archived.">
    {
      Object.entries(
        getPostsByGroupCondition(posts, post =>
          post.data.pubDatetime.getFullYear()
        )
      )
        .sort(([yearA], [yearB]) => Number(yearB) - Number(yearA))
        .map(([year, yearGroup]) => {
          const sortedYear = yearGroup.sort(
            (a, b) =>
              new Date(b.data.pubDatetime).getTime() -
              new Date(a.data.pubDatetime).getTime()
          );
          const topFive = sortedYear.slice(0, 5);
          const hasMore = sortedYear.length > 5;

          return (
            <div class="mt-8">
              <div class="flex items-baseline gap-2">
                <span class="text-3xl font-bold text-accent">{year}</span>
                <sup class="text-sm opacity-75">{sortedYear.length}</sup>
              </div>
              <ol class="relative my-4 ms-4 border-s-2 border-accent/60">
                {topFive.map(({ data, id, filePath }) => (
                  <li class="relative ps-4 py-3">
                    <a
                      href={getPath(id, filePath)}
                      class="block text-base font-medium text-foreground hover:text-accent focus-visible:outline-2 focus-visible:outline-dashed focus-visible:outline-accent"
                    >
                      {data.title}
                    </a>
                    <Datetime
                      pubDatetime={data.pubDatetime}
                      modDatetime={data.modDatetime}
                      timezone={data.timezone}
                    />
                  </li>
                ))}
                {hasMore && <li class="relative ps-4 py-2 opacity-70">â€¦</li>}
              </ol>
            </div>
          );
        })
    }
  </Main>
  <Footer />
</Layout>
