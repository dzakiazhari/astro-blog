---
import { getCollection } from "astro:content";
import Main from "@/layouts/Main.astro";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import { getPath } from "@/utils/getPath";
import Datetime from "@/components/Datetime.astro";
import getPostsByGroupCondition from "@/utils/getPostsByGroupCondition";
import { SITE } from "@/config";

// Redirect to 404 page if `showArchives` config is false
if (!SITE.showArchives) {
  return Astro.redirect("/404");
}

const posts = await getCollection("blog", ({ data }) => !data.draft);
---

<Layout title={`Archives | ${SITE.title}`}>
  <Header />
  <Main pageTitle="Archives" pageDesc="All the articles I've archived.">
    {
      Object.entries(
        getPostsByGroupCondition(posts, post =>
          post.data.pubDatetime.getFullYear()
        )
      )
        .sort(([yearA], [yearB]) => Number(yearB) - Number(yearA))
        .map(([year, yearGroup]) => {
          const sortedYear = yearGroup.sort(
            (a, b) =>
              new Date(b.data.pubDatetime).getTime() -
              new Date(a.data.pubDatetime).getTime()
          );
          const topFive = sortedYear.slice(0, 5);
          const hasMore = sortedYear.length > 5;

          return (
            <section class="mt-12">
              <header class="flex items-center gap-3">
                <span class="type-overline-wide rounded-[var(--radius-xs)] border border-[var(--border-soft)] bg-[var(--surface-subtle)] px-3 py-1 font-semibold text-[color:var(--muted-text)] uppercase">
                  {year}
                </span>
                <sup class="type-caption text-[color:var(--muted-text)]">
                  {sortedYear.length}
                </sup>
              </header>
              <ol class="relative my-6 ms-3 space-y-4 border-s border-[var(--divider-soft)] ps-5">
                {topFive.map(({ data, id, filePath }) => (
                  <li class="relative rounded-[var(--radius-md)] border border-[var(--border-soft)] bg-[var(--surface-subtle)] p-4 transition-colors duration-150 hover:border-[color:var(--border-strong)]">
                    <span class="absolute start-[-2.65rem] top-1.5 inline-block size-2 border border-[color:var(--border-strong)] bg-[color:var(--nav-text-strong)]" />
                    <a
                      href={getPath(id, filePath)}
                      class="type-heading-sm block font-semibold text-[color:var(--body-text)] transition-colors duration-150 hover:text-[color:var(--nav-text-strong)] focus-visible:ring-2 focus-visible:ring-[color:var(--ring-accent)] focus-visible:outline-none"
                      data-astro-prefetch="viewport"
                    >
                      {data.title}
                    </a>
                    <Datetime
                      class="type-overline-tight mt-2 text-[color:var(--muted-text)]"
                      pubDatetime={data.pubDatetime}
                      modDatetime={data.modDatetime}
                      timezone={data.timezone}
                    />
                  </li>
                ))}
                {hasMore && (
                  <li class="type-overline-wide relative ps-2 font-semibold text-[color:var(--muted-text)] uppercase">
                    â€¦
                  </li>
                )}
              </ol>
            </section>
          );
        })
    }
  </Main>
  <Footer />
</Layout>
