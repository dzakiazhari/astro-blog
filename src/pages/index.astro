---
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Socials from "@/components/Socials.astro";
import LinkButton from "@/components/LinkButton.astro";
import Card from "@/components/Card.astro";
import getSortedPosts from "@/utils/getSortedPosts";
import IconGarden from "@/assets/icons/IconGarden.svg";
import IconRss from "@/assets/icons/IconRss.svg";
import IconArrowRight from "@/assets/icons/IconArrowRight.svg";
import { SOCIALS } from "@/constants";
import { SITE } from "@/config";

const posts = await getCollection("blog");

const sortedPosts = getSortedPosts(posts);
const featuredPosts = sortedPosts.filter(({ data }) => data.featured);
const recentPosts = sortedPosts.filter(({ data }) => !data.featured);
---

<Layout>
  <Header />
  <main
    id="main-content"
    data-layout="index"
    class="site-shell space-y-10 pt-12 pb-16"
  >
    <section
      class="rounded-[var(--radius-lg)] border border-[var(--border-soft)] bg-[var(--surface-raised)] px-5 py-10 sm:px-6 md:py-12"
    >
      <div
        class="grid grid-cols-1 gap-8 md:grid-cols-12 md:items-start md:gap-10"
      >
        <div class="space-y-5 md:col-span-6 md:pe-8 lg:col-span-6 lg:pe-10">
          <h1
            class="text-4xl font-semibold text-[color:var(--nav-text-strong)] sm:text-[2.75rem]"
          >
            Hello.
          </h1>
          <p
            class="max-w-2xl text-base leading-relaxed text-[color:var(--muted-text)] sm:text-lg"
          >
            Explore stories, research notes, and the studio's experiments.
          </p>
          <div class="flex flex-wrap gap-2.5 md:gap-3.5">
            <LinkButton href="/posts/" prefetch="viewport">
              Latest posts
            </LinkButton>
            <LinkButton href="/about" prefetch="viewport">
              About the studio
            </LinkButton>
          </div>
        </div>

        <div
          class="grid grid-cols-1 gap-3.5 sm:grid-cols-2 md:col-span-6 md:gap-5 lg:col-span-6"
        >
          <a
            href={SITE.notesUrl ?? "https://notes.dzakiazhari.com"}
            class="group relative flex min-h-[180px] flex-col justify-between rounded-[var(--radius-md)] border border-[var(--border-soft)] bg-[var(--surface-subtle)] p-5 text-left transition-colors duration-200 hover:border-[color:var(--border-strong)] focus-visible:ring-2 focus-visible:ring-[color:var(--ring-accent)] focus-visible:outline-none"
            rel="noopener noreferrer"
            target="_blank"
            data-astro-prefetch="false"
          >
            <span
              class="inline-flex items-center gap-2 text-[0.68rem] font-semibold tracking-[0.3em] text-[color:var(--muted-text)] uppercase"
            >
              <IconGarden class="size-4" aria-hidden="true" />
              Notes garden
            </span>
            <span
              class="text-[1.7rem] leading-snug font-semibold text-[color:var(--nav-text-strong)]"
            >
              Visit the evergreen notes
            </span>
            <span
              class="mt-auto inline-flex items-center gap-2 text-[0.66rem] font-semibold tracking-[0.26em] text-[color:var(--nav-text)] uppercase transition-colors duration-150 group-hover:text-[color:var(--nav-text-strong)]"
            >
              Explore notes
              <IconGarden class="size-[0.95rem]" aria-hidden="true" />
            </span>
          </a>

          <a
            href="/rss.xml"
            class="group flex min-h-[180px] flex-col justify-between rounded-[var(--radius-md)] border border-[var(--border-soft)] bg-[var(--surface-raised)] p-5 text-left transition-colors duration-200 hover:border-[color:var(--border-strong)] focus-visible:ring-2 focus-visible:ring-[color:var(--ring-accent)] focus-visible:outline-none"
            aria-label="rss feed"
            rel="noopener noreferrer"
            title="RSS Feed"
          >
            <span
              class="text-[0.68rem] font-semibold tracking-[0.3em] text-[color:var(--muted-text)] uppercase"
            >
              Stay updated
            </span>
            <span
              class="text-[1.7rem] leading-snug font-semibold text-[color:var(--nav-text-strong)]"
            >
              Subscribe via RSS
            </span>
            <span
              class="mt-auto inline-flex items-center gap-2 text-[0.68rem] font-semibold tracking-[0.26em] text-[color:var(--nav-text)] uppercase transition-colors duration-150 group-hover:text-[color:var(--nav-text-strong)]"
            >
              Feed
              <IconRss width={18} height={18} class="rtl:-rotate-90" />
            </span>
          </a>
        </div>
      </div>

      {
        SOCIALS.length > 0 && (
          <div class="mt-7 flex flex-wrap items-center gap-3.5 border-t border-[var(--divider-soft)] pt-5">
            <span class="text-[0.66rem] tracking-[0.3em] text-[color:var(--muted-text)] uppercase">
              Connect
            </span>
            <Socials />
          </div>
        )
      }
    </section>

    <section class="grid grid-cols-1 gap-8 md:grid-cols-12 lg:gap-10">
      {
        featuredPosts.length > 0 && (
          <div class="space-y-4 md:col-span-6">
            <h2 class="text-[0.78rem] font-semibold tracking-[0.28em] text-[color:var(--muted-text)] uppercase">
              Featured
            </h2>
            <ul class="grid gap-5">
              {featuredPosts.slice(0, 3).map(data => (
                <Card variant="h3" showDescription={false} {...data} />
              ))}
            </ul>
          </div>
        )
      }

      {
        recentPosts.length > 0 && (
          <div class="space-y-4 md:col-span-6">
            <h2 class="text-[0.78rem] font-semibold tracking-[0.28em] text-[color:var(--muted-text)] uppercase">
              Recent Posts
            </h2>
            <ul class="grid gap-5">
              {recentPosts.slice(0, 3).map(data => (
                <Card variant="h3" showDescription={false} {...data} />
              ))}
            </ul>
          </div>
        )
      }
    </section>

    <div class="flex justify-center">
      <LinkButton href="/posts/" prefetch="viewport">
        View archive
        <IconArrowRight class="inline-block rtl:-rotate-180" />
      </LinkButton>
    </div>
  </main>
  <Footer />
</Layout>

<script>
  document.addEventListener("astro:page-load", () => {
    const indexLayout = (document.querySelector("#main-content") as HTMLElement)
      ?.dataset?.layout;
    if (indexLayout) {
      sessionStorage.setItem("backUrl", "/");
    }
  });
</script>
