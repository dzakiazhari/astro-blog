---
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Socials from "@/components/Socials.astro";
import LinkButton from "@/components/LinkButton.astro";
import Card from "@/components/Card.astro";
import getSortedPosts from "@/utils/getSortedPosts";
import IconRss from "@/assets/icons/IconRss.svg";
import IconArrowRight from "@/assets/icons/IconArrowRight.svg";
import { SOCIALS } from "@/constants";

const posts = await getCollection("blog");

const sortedPosts = getSortedPosts(posts);
const featuredPosts = sortedPosts.filter(({ data }) => data.featured);
const recentPosts = sortedPosts.filter(({ data }) => !data.featured);
---

<Layout>
  <Header />
  <main
    id="main-content"
    data-layout="index"
    class="site-shell space-y-12 pt-16 pb-20"
  >
    <section
      class="rounded-xl border border-border/60 bg-background/75 px-6 py-12 shadow-[0_24px_68px_rgba(24,20,45,0.14)] backdrop-blur-sm"
    >
      <div class="flex flex-wrap items-center justify-between gap-4">
        <div class="space-y-4">
          <p
            class="text-[0.75rem] font-semibold tracking-[0.32em] text-foreground/50 uppercase"
          >
            Welcome traveler
          </p>
          <h1 class="text-4xl font-semibold text-foreground sm:text-[2.8rem]">
            Hello, I'm Dzaki.
          </h1>
          <p
            class="max-w-2xl text-base leading-relaxed text-foreground/70 sm:text-lg"
          >
            Explore stories, research notes, and ideas from the studio. For
            deeper rabbit holes, hop over to the
            <LinkButton
              class="border-transparent px-0 py-0 text-accent hover:text-accent"
              href="https://notes.dzakiazhari.com"
              prefetch="false"
              rel="noopener noreferrer"
              target="_blank"
            >
              notes garden â†—
            </LinkButton>
            .
          </p>
        </div>
        <a
          target="_blank"
          href="/rss.xml"
          class="inline-flex items-center gap-2 rounded-lg border border-border/60 px-4 py-2 text-[0.72rem] font-semibold tracking-[0.26em] text-foreground/70 uppercase transition-colors duration-150 hover:border-accent/40 hover:text-accent focus-visible:ring-2 focus-visible:ring-accent/35 focus-visible:outline-none"
          aria-label="rss feed"
          rel="noopener noreferrer"
          title="RSS Feed"
        >
          <IconRss width={16} height={16} class="rtl:-rotate-90" />
          RSS
        </a>
      </div>

      {
        SOCIALS.length > 0 && (
          <div class="mt-8 flex flex-wrap items-center gap-4 border-t border-border/60 pt-6">
            <span class="text-[0.68rem] tracking-[0.32em] text-foreground/50 uppercase">
              Connect
            </span>
            <Socials />
          </div>
        )
      }
    </section>

    <section class="grid gap-10 md:grid-cols-2">
      {
        featuredPosts.length > 0 && (
          <div class="space-y-5">
            <h2 class="text-[0.82rem] font-semibold tracking-[0.32em] text-foreground/60 uppercase">
              Featured
            </h2>
            <ul class="grid gap-6">
              {featuredPosts.slice(0, 3).map(data => (
                <Card variant="h3" showDescription={false} {...data} />
              ))}
            </ul>
          </div>
        )
      }

      {
        recentPosts.length > 0 && (
          <div class="space-y-5">
            <h2 class="text-[0.82rem] font-semibold tracking-[0.32em] text-foreground/60 uppercase">
              Recent Posts
            </h2>
            <ul class="grid gap-6">
              {recentPosts.slice(0, 3).map(data => (
                <Card variant="h3" showDescription={false} {...data} />
              ))}
            </ul>
          </div>
        )
      }
    </section>

    <div class="flex justify-center">
      <LinkButton href="/posts/" prefetch="viewport">
        View archive
        <IconArrowRight class="inline-block rtl:-rotate-180" />
      </LinkButton>
    </div>
  </main>
  <Footer />
</Layout>

<script>
  document.addEventListener("astro:page-load", () => {
    const indexLayout = (document.querySelector("#main-content") as HTMLElement)
      ?.dataset?.layout;
    if (indexLayout) {
      sessionStorage.setItem("backUrl", "/");
    }
  });
</script>
