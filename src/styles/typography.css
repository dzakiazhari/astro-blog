@plugin '@tailwindcss/typography';

@layer base {
  /* ===== Override default Tailwind Typography styles ===== */
  .app-prose {
    @apply prose;

    h1,
    h2,
    h3,
    h4,
    th {
      @apply mb-3 font-semibold text-foreground;
    }

    h1 {
      @apply text-3xl sm:text-[2.5rem] md:text-[2.75rem];
      text-wrap: balance;
      letter-spacing: -0.01em;
    }

    h2,
    h3 {
      @apply relative pl-5;
    }

    h2 {
      @apply text-[1.65rem] sm:text-3xl;
      text-wrap: balance;
    }

    h3 {
      @apply text-xl sm:text-[1.4rem];
    }

    h2::before,
    h3::before {
      content: "";
      position: absolute;
      inset-block: 0.35em;
      inset-inline-start: 0;
      width: 0.18rem;
      border-radius: 9999px;
      background: linear-gradient(
        180deg,
        color-mix(in oklab, var(--color-accent) 92%, transparent 8%),
        color-mix(in oklab, var(--color-accent) 40%, transparent 60%)
      );
    }

    h2 > a[aria-hidden="true"],
    h3 > a[aria-hidden="true"] {
      position: absolute;
      inset-inline-start: -1.85rem;
      inset-block-start: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 1.35rem;
      height: 1.35rem;
      @apply text-accent/50 transition-colors duration-150 ease-out;
    }

    h2 > a[aria-hidden="true"]:where(:hover, :focus-visible),
    h3 > a[aria-hidden="true"]:where(:hover, :focus-visible) {
      @apply text-accent;
    }

    h4 {
      @apply mt-8 text-[0.72rem] tracking-[0.26em] text-foreground/70 uppercase;
      letter-spacing: 0.26em;
    }

    p,
    strong,
    ol,
    ul,
    figcaption,
    table,
    code {
      @apply text-foreground;
    }

    /* More readable paragraphs */
    p {
      text-align: start;
      text-wrap: pretty;
      hyphens: auto;
      @apply leading-relaxed;
    }

    a {
      @apply break-words text-foreground decoration-dashed underline-offset-4 hover:text-accent focus-visible:no-underline;
    }

    ul {
      @apply overflow-x-clip;
    }

    li {
      @apply marker:text-accent;
    }

    hr {
      @apply border-border;
    }

    img {
      @apply mx-auto rounded border border-border/70 shadow-sm;
    }

    figcaption {
      @apply opacity-75;
    }

    table {
      th,
      td {
        @apply border border-border p-2;
      }

      th {
        @apply py-1.5;
      }

      code {
        @apply break-all sm:break-normal;
      }
    }

    code {
      @apply rounded-[0.35rem] bg-muted/60 px-1 py-0.5 break-words text-foreground before:content-none after:content-none;
    }

    /* Quartz-like blockquote */
    blockquote:not(.callout) {
      border-inline-start: 2px solid
        color-mix(in oklab, var(--color-accent) 55%, transparent 45%);
      padding-inline-start: 1.1rem;
      margin: 1.25rem 0;
      color: var(--color-foreground);
      background: color-mix(in oklab, var(--color-muted) 35%, transparent 65%);
      border-radius: 0.5rem;
      transition:
        border-color 0.2s ease,
        background-color 0.2s ease;
    }

    details {
      @apply inline-block cursor-pointer text-foreground select-none [&_p]:hidden [&_ul]:!my-0;
    }

    summary {
      @apply focus-visible:no-underline focus-visible:outline-2 focus-visible:outline-offset-1 focus-visible:outline-accent focus-visible:outline-dotted;
    }

    pre {
      @apply focus-visible:border-transparent focus-visible:outline-2 focus-visible:outline-accent focus-visible:outline-dotted;
    }
  }

  /* ===== Code Blocks & Syntax Highlighting ===== */
  .expressive-code {
    @apply my-6;
    scroll-margin-top: 6.5rem;
  }

  .expressive-code .frame {
    border-radius: 1rem;
    overflow: clip;
    transition:
      box-shadow 180ms ease,
      transform 180ms ease;
  }

  @media (prefers-reduced-motion: reduce) {
    .expressive-code .frame {
      transition-duration: 1ms;
      transition-property: box-shadow;
      transform: none !important;
    }
  }

  .expressive-code:where(:hover, :focus-within) .frame {
    box-shadow: 0 26px 56px
      color-mix(in oklab, var(--foreground) 10%, transparent 90%);
    transform: translate3d(0, -2px, 0);
  }

  .expressive-code pre {
    font-variant-ligatures: contextual;
    scrollbar-width: thin;
    overscroll-behavior: contain;
  }

  .expressive-code pre::-webkit-scrollbar {
    height: 6px;
  }

  .expressive-code pre::-webkit-scrollbar-thumb {
    background-color: color-mix(
      in oklab,
      var(--foreground) 18%,
      transparent 82%
    );
    border-radius: 9999px;
  }

  .expressive-code pre::-webkit-scrollbar-track {
    background: transparent;
  }

  .expressive-code .copy button {
    border-radius: 9999px;
    box-shadow: none;
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
  }

  .expressive-code .copy button div {
    border-radius: inherit;
    backdrop-filter: blur(18px);
    -webkit-backdrop-filter: blur(18px);
  }

  .expressive-code .copy button::after {
    margin: 0.42rem;
  }

  .expressive-code .copy .feedback {
    font-size: 0.68rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  /* Text highlight via <mark> — Quartz translucent note */
  mark {
    @apply rounded-md border px-1.5 py-0.5 font-medium;
    background-color: color-mix(
      in oklab,
      var(--text-highlight) 100%,
      transparent 0%
    );
    border-color: color-mix(in oklab, var(--darkgray) 42%, transparent 58%);
    color: var(--foreground);
  }

  html[data-theme="dark"] mark {
    border-color: color-mix(in oklab, var(--darkgray) 46%, transparent 54%);
    box-shadow: 0 0 0 1px
      color-mix(in oklab, var(--highlight) 68%, transparent 32%);
    color: var(--foreground);
  }
}

/* ===== Quartz-style Callouts (Obsidian-style [!NOTE] etc.) ===== */
@layer base {
  /* Base container */
  .callout {
    border: 1px solid var(--border);
    background-color: var(--bg);
    border-radius: 0.6rem;
    padding: 0.75rem 1rem;
    margin: 1rem 0;
    box-sizing: border-box;
  }

  /* Title (first paragraph) */
  .callout > p:first-child {
    margin-top: 0;
    margin-bottom: 0.35rem;
    font-weight: 600;
    color: var(--color);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* Icon bubble before the title */
  .callout > p:first-child::before {
    content: "";
    --icon-size: 18px;
    width: var(--icon-size);
    height: var(--icon-size);
    flex: 0 0 var(--icon-size);
    background-color: var(--color);
    mask-image: var(--callout-icon);
    mask-size: var(--icon-size) var(--icon-size);
    mask-position: center;
    mask-repeat: no-repeat;
    display: inline-block;
  }

  /* Reset nested blockquote spacing inside callout */
  .callout blockquote {
    margin: 0.5rem 0 0 0;
  }

  /* Default icon set as CSS vars */
  .callout {
    --callout-icon-note: url('data:image/svg+xml; utf8, <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="2" x2="22" y2="6"></line><path d="M7.5 20.5 19 9l-4-4L3.5 16.5 2 22z"></path></svg>');
    --callout-icon-abstract: url('data:image/svg+xml; utf8, <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><path d="M12 11h4"></path><path d="M12 16h4"></path><path d="M8 11h.01"></path><path d="M8 16h.01"></path></svg>');
    --callout-icon-info: url('data:image/svg+xml; utf8, <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>');
    --callout-icon-todo: url('data:image/svg+xml; utf8, <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg>');
    --callout-icon-tip: url('data:image/svg+xml; utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"></path></svg> ');
    --callout-icon-success: url('data:image/svg+xml; utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg> ');
    --callout-icon-question: url('data:image/svg+xml; utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg> ');
    --callout-icon-warning: url('data:image/svg+xml; utf8, <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>');
    --callout-icon-failure: url('data:image/svg+xml; utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg> ');
    --callout-icon-danger: url('data:image/svg+xml; utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg> ');
    --callout-icon-bug: url('data:image/svg+xml; utf8, <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="8" height="14" x="8" y="6" rx="4"></rect><path d="m19 7-3 2"></path><path d="m5 7 3 2"></path><path d="m19 19-3-2"></path><path d="m5 19 3-2"></path><path d="M20 13h-4"></path><path d="M4 13h4"></path><path d="m10 4 1 2"></path><path d="m14 4-1 2"></path></svg>');
    --callout-icon-example: url('data:image/svg+xml; utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg> ');
    --callout-icon-quote: url('data:image/svg+xml; utf8, <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"></path><path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2h.75c0 2.25.25 4-2.75 4v3c0 1 0 1 1 1z"></path></svg>');
  }

  /* Variant tokens */
  .callout[data-callout] {
    --color: #448aff;
    --border: #448aff44;
    --bg: #448aff10;
    --callout-icon: var(--callout-icon-note);
  }
  .callout[data-callout="abstract"] {
    --color: #00b0ff;
    --border: #00b0ff44;
    --bg: #00b0ff10;
    --callout-icon: var(--callout-icon-abstract);
  }
  .callout[data-callout="info"],
  .callout[data-callout="todo"] {
    --color: #00b8d4;
    --border: #00b8d444;
    --bg: #00b8d410;
    --callout-icon: var(--callout-icon-info);
  }
  .callout[data-callout="todo"] {
    --callout-icon: var(--callout-icon-todo);
  }
  .callout[data-callout="tip"] {
    --color: #00bfa5;
    --border: #00bfa544;
    --bg: #00bfa510;
    --callout-icon: var(--callout-icon-tip);
  }
  .callout[data-callout="success"] {
    --color: #09ad7a;
    --border: #09ad7144;
    --bg: #09ad7110;
    --callout-icon: var(--callout-icon-success);
  }
  .callout[data-callout="question"] {
    --color: #dba642;
    --border: #dba64244;
    --bg: #dba64210;
    --callout-icon: var(--callout-icon-question);
  }
  .callout[data-callout="warning"] {
    --color: #db8942;
    --border: #db894244;
    --bg: #db894210;
    --callout-icon: var(--callout-icon-warning);
  }
  .callout[data-callout="failure"],
  .callout[data-callout="danger"],
  .callout[data-callout="bug"] {
    --color: #db4242;
    --border: #db424244;
    --bg: #db424210;
    --callout-icon: var(--callout-icon-failure);
  }
  .callout[data-callout="bug"] {
    --callout-icon: var(--callout-icon-bug);
  }
  .callout[data-callout="danger"] {
    --callout-icon: var(--callout-icon-danger);
  }
  .callout[data-callout="example"] {
    --color: #7a43b5;
    --border: #7a43b544;
    --bg: #7a43b510;
    --callout-icon: var(--callout-icon-example);
  }
  .callout[data-callout="quote"] {
    --color: var(--color-accent);
    --border: var(--color-lightgray);
    --callout-icon: var(--callout-icon-quote);
  }
}

.code-block {
  position: relative;
}

.code-block pre {
  --code-copy-offset: 1.35rem;
  @apply rounded-xl border border-border/60 bg-muted/70 px-5 py-4 text-sm leading-7 text-foreground shadow-lg;
  box-shadow: 0 18px 36px
    color-mix(in oklab, var(--foreground) 6%, transparent 94%);
}

.code-block .copy-code {
  @apply absolute inline-flex items-center gap-1 text-[0.68rem] font-medium tracking-[0.12em] text-foreground/80 uppercase transition duration-150 ease-out focus-visible:ring-2 focus-visible:ring-accent/35 focus-visible:outline-none;
  min-height: 2.1rem;
  padding: 0.42rem 1rem;
  inset-inline-end: 1rem;
  inset-block-start: var(--copy-button-top, 1.2rem);
  transform: translateY(-50%);
  border-radius: 0.85rem;
  border: 1px solid color-mix(in oklab, var(--border) 70%, transparent 30%);
  background: color-mix(in oklab, var(--background) 82%, var(--foreground) 18%);
  touch-action: manipulation;
  z-index: 2;
  opacity: 0.75;
}

.code-block .copy-code::before {
  content: "⧉";
  font-size: 0.72rem;
  opacity: 0.7;
}

.code-block .copy-code:hover,
.code-block .copy-code:focus-visible,
.code-block:focus-within .copy-code {
  @apply text-foreground;
  background: color-mix(in oklab, var(--background) 78%, var(--foreground) 22%);
  border-color: color-mix(in oklab, var(--border) 72%, transparent 28%);
  opacity: 1;
}

.code-block .copy-code[data-state="copied"] {
  @apply text-accent;
  background: color-mix(in oklab, var(--accent) 22%, transparent 78%);
  border-color: color-mix(in oklab, var(--accent) 36%, transparent 64%);
  opacity: 1;
}

.code-block .copy-code[data-state="copied"]::before {
  content: "✔";
  opacity: 1;
}

@media (hover: hover) {
  .code-block .copy-code {
    opacity: 0;
  }

  .code-block:hover .copy-code,
  .code-block:focus-within .copy-code,
  .code-block .copy-code[data-state="copied"] {
    opacity: 0.85;
  }
}

html[data-theme="dark"] .code-block pre {
  @apply border-border/50 bg-muted/40 text-foreground;
}

html[data-theme="dark"] .code-block .copy-code {
  background: color-mix(in oklab, var(--background) 70%, var(--foreground) 30%);
  border-color: color-mix(in oklab, var(--border) 56%, transparent 44%);
  color: color-mix(in oklab, var(--foreground) 86%, var(--background) 14%);
}

html[data-theme="dark"] .code-block .copy-code[data-state="copied"] {
  color: var(--foreground);
}
