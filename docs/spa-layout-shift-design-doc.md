# SPA Layout Shift Design Audit

## Evaluation Iterations
1. **Container width strategy diverges between page types.** List pages use the shared `site-shell` utility that constrains width with a viewport-sensitive `calc`, while post details switch to a bespoke `max-w-app` wrapper. The sudden change in gutter math introduces noticeable horizontal snapping during SPA swaps.【F:src/styles/global.css†L941-L951】【F:src/layouts/PostDetails.astro†L132-L138】
2. **Header navigation reflows dramatically on hydration.** The primary nav is authored as a CSS grid that collapses to `hidden` until a script toggles classes, so route transitions momentarily hide and then reveal the menu, causing a pronounced jump in layout.【F:src/components/Header.astro†L69-L200】
3. **Breadcrumb injection shifts the main column.** Pages rendered through `Main.astro` prepend a breadcrumb with its own vertical margins that do not exist on the homepage, so navigating from home to a posts listing inserts extra vertical spacing and pushes content downward mid-transition.【F:src/layouts/Main.astro†L23-L56】【F:src/components/Breadcrumb.astro†L26-L68】
4. **Hero grid height mismatch amplifies vertical snap.** The homepage hero uses an asymmetric 12-column grid with tall cards, unlike the compact stacked sections elsewhere, so entering or exiting the index replaces the main fold with drastically different block heights that animate under the SPA router.【F:src/pages/index.astro†L25-L165】
5. **Card view-transition hooks animate unintended regions.** Each card headline receives a `viewTransitionName`, and the post detail title reuses the same slug, letting the browser morph large text blocks between routes—an effect that drags surrounding layout along and exaggerates perceived shift.【F:src/components/Card.astro†L36-L127】【F:src/layouts/PostDetails.astro†L141-L145】
6. **Global ClientRouter enables whole-document transitions.** The base layout injects `ClientRouter` without scoping or disabling default view transition captures, so every SPA navigation snapshots the full viewport before swapping, producing the “everything moves” complaint.【F:src/layouts/Layout.astro†L2-L158】
7. **Inconsistent shell padding compounds horizontal jitter.** `Main.astro` wraps content in a `section` with `px-5 sm:px-6`, while the homepage hero uses `px-4 sm:px-6`; the mismatch creates a lateral nudge when the router swaps sections that align to different padding widths.【F:src/layouts/Main.astro†L23-L55】【F:src/pages/index.astro†L30-L112】
8. **Pagination block appears and disappears abruptly.** Listings append a centered pagination nav only when more than one page exists; its late render adds bottom padding and button height after data loads, leading to subtle bottom-of-page jumps.【F:src/components/Pagination.astro†L15-L46】
9. **Footer spacing depends on contextual flags.** The footer’s `mt-auto` toggle responds to a `noMarginTop` prop, so pages with pagination drop the top margin while others keep it, making the footer leap upward or downward between routes.【F:src/components/Footer.astro†L12-L21】【F:src/components/Pagination.astro†L15-L46】
10. **Back-button session state rewrites layout between visits.** `Main.astro` writes the current path into session storage on every `astro:page-load`, influencing back-button rendering choices and occasionally inserting or removing control rows after hydration completes.【F:src/layouts/Main.astro†L58-L67】【F:src/components/BackButton.astro†L1-L47】
11. **Mobile menu toggling introduces delayed height changes.** The header’s hamburger button switches the nav from `hidden` to `grid`, and because the script only binds once per mount, route swaps can recreate the header without the class toggle applied, leaving the nav collapsed until user interaction, which looks like a layout pop-in.【F:src/components/Header.astro†L88-L200】
12. **Reading-progress scripts add late-loading overlays.** Post pages enable scroll-enhancement scripts that append UI after `astro:page-load`, slightly shifting stacking context and scrolling space following navigation.【F:src/layouts/PostDetails.astro†L100-L200】【F:src/layouts/Layout.astro†L140-L154】

## Three-Phase Action Plan
1. **Stabilize baseline & instrumentation.**
   - Turn off global view transitions temporarily by configuring `ClientRouter` to skip captures, measure CLS across key routes, and log current layout metrics for reference.【F:src/layouts/Layout.astro†L2-L158】
   - Capture viewport recordings of home → posts → post detail flows to verify the exact points of shift described above.【F:src/pages/index.astro†L25-L165】【F:src/layouts/PostDetails.astro†L132-L200】

2. **Normalize structural layout primitives.**
   - Harmonize container utilities so `site-shell` and `max-w-app` share padding and width math, and ensure breadcrumbs reserve vertical space even when absent to avoid sudden pushes.【F:src/styles/global.css†L941-L951】【F:src/layouts/Main.astro†L23-L56】【F:src/components/Breadcrumb.astro†L26-L68】【F:src/layouts/PostDetails.astro†L132-L138】
   - Align hero and listing sections to a consistent grid rhythm, or introduce transition-safe placeholders that keep heights steady during swaps.【F:src/pages/index.astro†L30-L157】【F:src/components/Card.astro†L41-L131】
   - Unify footer spacing rules so the footer occupies predictable space regardless of pagination state.【F:src/components/Footer.astro†L12-L21】【F:src/components/Pagination.astro†L15-L46】

3. **Refine interactive behaviors.**
   - Scope view transitions to specific elements (or disable them) and remove the `viewTransitionName` hooks from cards unless paired with stable target surfaces, reducing unintended morphing.【F:src/components/Card.astro†L36-L127】【F:src/layouts/PostDetails.astro†L141-L145】
   - Refactor the header menu to avoid relying on JS toggles for initial layout, ensuring the nav renders in its resting state across route swaps.【F:src/components/Header.astro†L69-L200】
   - Defer optional scroll-enhancement scripts until after first render or gate them behind interaction so they no longer inject layout-affecting elements post-navigation.【F:src/layouts/Layout.astro†L140-L154】【F:src/layouts/PostDetails.astro†L100-L200】
